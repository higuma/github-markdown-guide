# コードスパン

[画像](images.md)
← [目次](index.md) →
[HTMLインライン](html-inlines.md)

------------------------------------------------------------------------

> 2022-12-31 TODO: つい最近GitHub側で追加対応が行われ、コードスパン内の連続スペースが縮約されなくなった(詳しい時期は不明だがここ1ヶ月以内)。そのため全面的な書き直しが必要。

コードスパンは[インライン]構文中のコードを表現する。

## 基本的な書き方

コードスパンは挿入するコード文字列の前後をバックティック(`` ` ``)で囲んで表現する。コードは等幅フォントで表示される。

```markdown
DOMのグローバルオブジェクトは`window`で参照する。
```

> DOMのグローバルオブジェクトは`window`で参照する。

コードスパンはコードの表現が目的のため、内部では一切のMarkdown記法が無効になりそのまま表示される。

```markdown
`**太字ではない**`, `[リンクではない](http::github.com)`, `<sup>上付きではない</sup>`
```

> `**太字ではない**`, `[リンクではない](http::github.com)`, `<sup>上付きではない</sup>`

コードスパン内部では[バックスラッシュエスケープ]や[文字参照]も同様に無効になる。

```markdown
`\* \\ &nbsp; &#x1234; puts("\\/\\/\\/\\/")`, `**太字ではない**`

`[リンクではない](http::github.com)`, `<sup>上付きではない</sup>`
```

> `\* \\ &nbsp; &#x1234; puts("\\/\\/\\/\\/")`
> `**太字ではない**`
> 
> `[リンクではない](http::github.com)`
> `<sup>上付きではない</sup>`

### コードスパン内部のバックティック

コードスパン内に連続でない`` ` ``が含まれる場合は次のシーケンスを用いるとよい。最初と最後のスペースは処理時に除去される。

* 開始は``` ``  ```&nbsp;(バックティック2個の後にスペース)
* 連続でない`` ` ``を含むコード
* 終了は```  `` ```&nbsp;(スペースの後にバックティック2個)

```markdown
シェルスクリプトのコマンド置換は`` `コマンド` ``で記述する(例: `` echo `ps` ``)。
```

> シェルスクリプトのコマンド置換は`` `コマンド` ``で記述する(例: `` echo `ps` ``)。

連続する`` ` ``を含む場合は次の記法を覚えておけばよい。

* 開始は```` ```  ````&nbsp;(内部の連続バックティックより多い個数の後にスペース)
* 連続する``` `` ```を含むコード (本例では2つ連続とする)
* 終了は````  ``` ````&nbsp;(スペースの後に開始と同じ数のバックティック)

```markdown
GFMではコードスパンを``` `` echo `ps` `` ```のように記述できる。
```

> GFMではコードスパンを``` `` echo `ps` `` ```のように記述できる。

## 文法まとめ

より正確な文法は次の通り。内部のコードでは[バックスラッシュエスケープ]や[文字参照]、またMarkdownの書式設定が全て無効になる、またHTMLで文字参照を用いる必要のある文字は自動的に変換を行い、HTMLの`<code>...</code>`の中に入れて出力する。正確な文法は次の通り。

* 開始: 1個以上の連続バックティック
* 0個以上のスペース
* コード記述
    * 特殊記号(`<`,`>`など)は自動的に文字参照に変換してHTML出力
    * 開始と同じ個数の連続バックティックを含んではならない(そこで終了と判定される)
* 0個以上のスペース
* 終了: 開始と同じ個数の連続バックティック

コードを`` `...` ``のように囲むのが基本形で、内部の特殊文字は全て文字参照に変換してHTMLに出力する(自分で処理する必要なし)。次の例では内部に`\`,`<`,`>`などを使っているが、これらはみな適切に変換されて文字通りのHTML出力を得られる。

```markdown
ソースコードの例(C): `printf("\"x = %5.2f\"\n", x);`

HTMLコードの例: `<a href="#">リンク</a>`
```

> ソースコードの例(C): `printf("\"x = %5.2f\"\n", x);`
> 
> HTMLコードの例: `<a href="#">リンク</a>`

開始/終了は1個以上の連続するバックティックを用いる。バックティックの連続個数で開始/終了を判定するため、コードスパン内部にバックティックがある場合は、その連続数と異なる連続バックティックを開始/終了に用いる。次のように内部で使っている最大連続数より多い数を用いればよい。

```markdown
```foo(`bar`, ``baz``)```
```

> ```foo(`bar`, ``baz``)```

逆に内部には連続する` `` `や` ``` `はあるが`` ` ``はない場合は外側に`` ` ``を使ってよい(異なる連続数であることが条件)。

```markdown
`foo(``bar``, ```baz```)`
```

> `foo(``bar``, ```baz```)`

コードスパンの先頭と末尾の両方にスペースがある場合は1対だけ除去してから処理する。2個以上の場合は前後1個ずつだけ除去する。どちらか一方だけの場合は除去しない。

```
` foo ` (前後1個ずつ) → <code>foo</code>
`  foo   ` (先頭に2個、末尾に3個) → <code> foo  </code> (先頭に1個、末尾に2個)
`foo ` (後ろのみ) → <code>foo </code> (処理されない)
`   foo` (手前のみ) → <code>   foo</code> (同上)
```

> これらはmarkdown処理実装が生成するHTML出力であり、ブラウザの表示結果とは異なることに注意。HTML側のレンダリング処理はもっと複雑で、この後の [HTMLレンダリング処理での空白の縮約と除去](#HTMLレンダリング処理での空白の縮約と除去) で詳しく解説する。

このルールを用いて最初や最後の文字が`` ` ``である場合を処理できる。次の例では内部に単独の`` ` ``があるため開始/終了は2個連続の` `` `を用いる。処理時はまず先頭と末尾のスペースが一個ずつ取り除かれ、残った文字列`` `command` ``をタグで囲んで``<code>`command`</code>``と出力する。

```markdown
`` `command` ``
```

> `` `command` ``

### HTMLレンダリング処理での空白の縮約と除去

Markdown側では開始直後と終了直前の両方にスペースがあれば1対だけ除去するというルールを適用した上で、必要な文字参照変換(`<`,`>`など)を行い`<code>`の中に出力する。しかしHTMLが`<code>...</code>`をレンダリング処理する際にはより複雑なルールで空白の縮約と除去が行われる。

まずコードスパン内部の連続する空白は全て1個に縮約される。

```markdown
ABC`   foo   bar      baz    `XYZ
```

> ABC`   foo   bar      baz    `XYZ

次にコードスパンの先頭が空白の場合、直前の文字が文頭または空白であればコードスパン先頭の空白が除去される。直前が非空白であれば除去されない。

| コードスパン直前 | 先頭空白 |       記述        |    出力     |
| ---------------- | -------- | ----------------- | ----------- |
| 文頭             | 除去     | `` ` code` ``     | ` code`     |
| 空白             | 除去     | `` KLM ` code` `` | KLM ` code` |
| 非空白           | 保存     | `` KLM` code` ``  | KLM` code`  |

コードスパン末尾の前後の振る舞いはさらに複雑で、コードスパン末尾の空白とコードスパン直後の空白の有無により出力が変化する。


| コードスパン末尾 | コードスパン直後   | 末尾空白 | 直後空白 |        記述         |    出力     |
| ---------------- | ------------------ | -------- | -------- | ------------------- | ----------- |
| 空白なし         | 文末または空白のみ | (なし)   | 除去     | `` `code`  ``&nbsp; | `code`      |
| 空白なし         | 空白の後に非空白   | (なし)   | 保存     | `` `code` EFG ``    | `code` EFG  |
| 空白あり         | 文末または空白     | 除去     | 除去     | `` `code `  ``&nbsp;| `code `     |
| 空白あり         | 非空白             | 保存     |(なし)    | `` `code `EFG ``    | `code `EFG  |
| 空白あり         | 空白の後に非空白   | 保存     | 除去     | `` `code ` EFG ``   | `code ` EFG |

> 以上の結果では特にコードスパン直前の空白とコードスパン内の先頭の空白を両方残すことができない点に注意。同様にコードスパン末尾の空白とコードスパン直後の空白を両方残すこともできない。これらの対策はこの次のExamplesで説明する。

### 表内部の`|`のエスケープ

コードスパン内で[バックスラッシュエスケープ]が無効になり`\`がそのまま表示されるが、一つだけ例外がある。[表]の見出し及びデータセルの内部ではコードスパン内の`|`に対して[バックスラッシュエスケープ]が必要になる。実例を示す。

```markdown
| 1 | 2 | 3 | 4 | 5 | 6 |
| - | - | - | - | - | - |
| `z = |x| + |y|` | 2 | 3 | 4 | 5 | 6 |
```

> | 1 | 2 | 3 | 4 | 5 | 
> | - | - | - | - | - |
> | `z = |x| + |y|` | 2 | 3 | 4 | 5 | 6 |

このように表の行内では`|`によるセル分割の方がコードスパンより文法的に優先するためセル区切りと判定されてしまう。この場合は次のようにコードスパン内の`|`をバックスラッシュエスケープする(特別ルール)。

```markdown
| 1 | 2 | 3 | 4 | 5 | 6 |
| - | - | - | - | - | - |
| `z = \|x\| + \|y\|` | 2 | 3 | 4 | 5 | 6 |
```

> | 1 | 2 | 3 | 4 | 5 | 6 |
> | - | - | - | - | - | - |
> | `z = \|x\| + \|y\|` | 2 | 3 | 4 | 5 | 6 |

## 文例

### 文字参照

コードスパン内部では各種書式設定や[文字参照]は使えない(そのまま出力される)。文字参照の代わりに任意のUnicode文字を直接入力すればよい。

```markdown
文字参照は無効 → `cr&egrave;me br&ucirc;l&eacute;e`

直接入力は可 → `crème brûlée`
```

> 文字参照は無効 → `cr&egrave;me br&ucirc;l&eacute;e`
> 
> 直接入力は可 → `crème brûlée`

### 先頭・末尾及び前後のスペースの制御

コードスパンの先頭と末尾の空白は制御が難しく、スペースだけでは次のようなことができない。

* コードスパンの直前とコードスパン内部の先頭の両方に空白を入れる
* コードスパン内部の末尾とコードスパン終了直後の両方に空白を入れる
* 文頭にあるコードスパン内部の先頭に空白を入れる
* 文末にあるコードスパン内部の末尾に空白を入れる

これらは[ノーブレークスペース]を使って対応できる。コードスパン直前及びコードスパン先頭の両方に空白を確保するにはコードスパン直前空白として`&nbsp;`を用いる。

```markdown
KLM ` code`

KLM&nbsp;` code`
```

> KLM ` code`
> 
> KLM&nbsp;` code`

<details>
<summary>スペース有無の全ケース一覧</summary>

| 直前空白 | 先頭空白 | 直前空白処理 | 先頭空白処理 |          記述          |       出力       |
| -------- | -------- | ------------ | ------------ | ---------------------- | ---------------- |
| なし     | なし     | (なし)       | (なし)       | `` KLM`code` ``        | KLM`code`        |
| なし     | あり     | (なし)       | 保存         | `` KLM` code` ``       | KLM` code`       |
| スペース | なし     | 保存         | (なし)       | `` KLM `code` ``       | KLM `code`       |
| スペース | あり     | 保存         | 除去         | `` KLM ` code` ``      | KLM ` code`      |
| `&nbsp;` | あり     | 保存         | 保存         | `` KLM&nbsp;` code` `` | KLM&nbsp;` code` |

</details>

コードスパン末尾及びコードスパン直後の両方に空白を入れる場合はコードスパン直後の空白に`&nbsp;`を用いる。

```markdown
`code ` EFG

`code `&nbsp;EFG
```

> `code ` EFG
> 
> `code `&nbsp;EFG

<details>
<summary>スペース有無の全ケース一覧</summary>

| 末尾空白 | 直後空白 | 末尾空白処理 | 直後空白処理 |          記述          |       出力       |
| -------- | -------- | ------------ | ------------ | ---------------------- | ---------------- |
| なし     | なし     | (なし)       | (なし)       | `` `code`EFG ``        | `code`EFG        |
| なし     | スペース | (なし)       | 保存         | `` `code` EFG ``       | `code` EFG       |
| あり     | なし     | 保存         | (なし)       | `` `code `EFG ``       | `code `EFG       |
| あり     | スペース | 保存         | 除去         | `` `code ` EFG ``      | `code ` EFG      |
| あり     | `&nbsp;` | 保存         | 保存         | `` `code `&nbsp;EFG `` | `code `&nbsp;EFG |

</details>

文頭にあるコードスパンの先頭に空白を入れる場合は`&NoBreak;`を用いる。

```markdown
` EFG`

&NoBreak;` EFG`
```

> ` EFG`
> 
> &NoBreak;` EFG`

文末にあるコードスパン内部の末尾に空白を入れる場合も同様。

```markdown
`KLM `

`KLM `&NoBreak;
```

> `KLM `
> 
> `KLM `&NoBreak;

### 内部への複数空白の確保

コードスパン内部の複数の連続するスペースはHTMLレンダリング処理時に縮約され、1つ分として表示される。


```markdown
&NoBreak;`    ----    ----    ----    `&NoBreak;
```

> &NoBreak;`    ----    ----    ----    `&NoBreak;

> TODO: 2022-12-31 こういうのが最近のGitHub Markdownではスペース縮約されなくなった(詳細時期不明だがここ1ヶ月以内)。ただし他の実装ではまだそういうことはなく、Babemarkで確認できるものは全てスペース縮約する。
> 
> https://babelmark.github.io/?text=%26NoBreak%3B%60++++----++++----++++----++++%60%26NoBreak%3B

[ノーブレークスペース]なら縮約されないが、コードスパン内部には文字参照は使えないので`&nbsp;`と書いても機能せずそのまま出力される。

```markdown
`&nbsp;&nbsp;&nbsp;&nbsp;----&nbsp;&nbsp;&nbsp;&nbsp;----&nbsp;&nbsp;&nbsp;&nbsp;`
```

> `&nbsp;&nbsp;&nbsp;&nbsp;----&nbsp;&nbsp;&nbsp;&nbsp;----&nbsp;&nbsp;&nbsp;&nbsp;`

ただしUnicode文字を直接入力することはできるので、これを利用してコードスパン中に縮約されない空白の連続を出力できる。次の例は空白部分にスペース(U+0020)ではなく[ノーブレークスペース]のU+00A0を直接入力して作成したもの。

```markdown
`    ----    ----    ----    `
```

> `    ----    ----    ----    `

ただしこの方法をプログラムコードの表現に用いた場合「内部のコードをコピーペーストしたのに原因不明で動かない」というような問題が発生する可能性に注意すること。特に古い言語実装には[ノーブレークスペース]を空白ではなく不正な文字として扱うものがよくある。

------------------------------------------------------------------------

[画像](images.md)
← [目次](index.md) →
[HTMLインライン](html-inlines.md)

[インライン]: inlines.md
[表]: tables.md
[文字参照]: characters.md#文字参照






[ノーブレークスペース]: character-references.md#ノーブレークスペース
[バックスラッシュエスケープ]: backslash-escapes.md
