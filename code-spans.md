# コードスパン

[画像](images.md)
← [目次](index.md) →
[HTMLインライン](html-inlines.md)

------------------------------------------------------------------------

> 2022-12-31 TODO: つい最近GitHub側で追加対応が行われ、コードスパン内の連続スペースが縮約されなくなった(詳しい時期は不明だがここ1ヶ月以内)。そのため全面的な書き直しが必要。

コードスパンは[インライン]構文中のコードを表現する。

## 基本的な書き方

コードスパンは挿入するコード文字列の前後をバックティック(`` ` ``)で囲んで表現する。コードは等幅フォントで表示される。

```markdown
DOMのグローバルオブジェクトは`window`で参照する。
```

> DOMのグローバルオブジェクトは`window`で参照する。

コードスパンの内部では一切のMarkdown記法が無効になりそのまま表示される。

```markdown
`**太字ではない**`, `[リンクではない](http::github.com)`, `<sup>上付きではない</sup>`
```

> `**太字ではない**`, `[リンクではない](http::github.com)`, `<sup>上付きではない</sup>`

コードスパン内部では[バックスラッシュエスケープ]や[文字参照]も同様に無効になる。

```markdown
`\* \\ &nbsp; &#x1234; puts("\\/\\/\\/\\/")`
```

> `\* \\ &nbsp; &#x1234; puts("\\/\\/\\/\\/")`

### コードスパン内部のバックティック

コードスパン内に連続でない`` ` ``が含まれる場合は次のシーケンスを用いるとよい。最初と最後のスペースは処理時に除去される。

* 開始は``` ``  ```&nbsp;(バックティック2個の後にスペース)
* 連続でない`` ` ``を含むコード
* 終了は```  `` ```&nbsp;(スペースの後にバックティック2個)

```markdown
シェルスクリプトのコマンド置換は`` `コマンド` ``で記述する(例: `` echo `ps` ``)。
```

> シェルスクリプトのコマンド置換は`` `コマンド` ``で記述する(例: `` echo `ps` ``)。

連続する`` ` ``を含む場合は次の記法を覚えておけばよい。

* 開始は```` ```  ````&nbsp;(内部の連続バックティックより多い個数の後にスペース)
* 連続する``` `` ```を含むコード (本例では2つ連続とする)
* 終了は````  ``` ````&nbsp;(スペースの後に開始と同じ数のバックティック)

```markdown
GFMではコードスパンを``` `` echo `ps` `` ```のように記述できる。
```

> GFMではコードスパンを``` `` echo `ps` `` ```のように記述できる。

## 文法まとめ

正確な文法は次の通り。内部のコードでは[バックスラッシュエスケープ]や[文字参照]、またMarkdownの書式設定が全て無効になる、またHTMLで文字参照を用いる必要のある文字は自動的に変換を行い、HTMLの`<code>...</code>`の中に入れて出力する。

1. 開始マーク: 1個以上の連続バックティック
2. 0個または1個のスペース(optional, 4と対で用いる)
3. コード記述
    * 特殊記号(`<`,`>`など)は自動的に文字参照に変換してHTML出力
    * 開始と同じ個数の連続バックティックを含んではならない(そこで終了と判定される)
4. 0個または1個のスペース(optional, 2と対)
5. 終了マーク: 開始と同じ個数の連続バックティック

コードを`` `...` ``のように囲むのが基本形で、内部の特殊文字は全て文字参照に変換してHTMLに出力する(自分で処理する必要なし)。次の例では内部に`\`,`<`,`>`などを使っているが、これらはみな適切に変換されて文字通りのHTML出力を得られる。

```markdown
ソースコードの例(C): `printf("\"x = %5.2f\"\n", x);`

HTMLコードの例: `<a href="#">リンク</a>`
```

> ソースコードの例(C): `printf("\"x = %5.2f\"\n", x);`
> 
> HTMLコードの例: `<a href="#">リンク</a>`

開始/終了は1個以上の連続するバックティックを用いる。バックティックの連続個数で開始/終了を判定するため、コードスパン内部にバックティックがある場合は、その連続数と異なる連続バックティックを開始/終了に用いる。通常は次のように内部で使っている最大連続数より多い数を用いればよい。

```markdown
```foo(`bar`, ``baz``)```
```

> ```foo(`bar`, ``baz``)```

逆に内部には連続する` `` `や` ``` `はあるが`` ` ``はない場合は外側に`` ` ``を使ってよい(異なる連続数であることが条件)。

```markdown
`foo(``bar``, ```baz```)`
```

> `foo(``bar``, ```baz```)`

### 前後のスペース除去

コードスパンの先頭と末尾の両方にスペースがある場合は前後1対だけ除去してから処理する。2個以上の場合は前後1個ずつだけ除去する。どちらか一方だけの場合は除去しない。

- `` ` foo ` `` (前後1個ずつ) → ` foo ` (前後とも除去)
- `` `  foo   ` `` (先頭2個、末尾3個) → `  foo   ` (先頭1個、末尾2個)
- `` `foo ` `` (後ろのみ1個) → `foo ` (除去されない)
- `` `   foo` `` (手前のみ2個) → `  foo` (同上)

このルールを用いて最初や最後の文字が`` ` ``である場合を処理できる。次の例では内部に単独の`` ` ``があるため開始/終了は2個連続の` `` `を用いる。処理時はまず先頭と末尾のスペースが一個ずつ取り除かれ、残った文字列`` `command` ``をタグで囲んで``<code>`command`</code>``と出力する。

```markdown
`` `command` ``
```

> `` `command` ``

### 表内部の`|`のエスケープ

コードスパン内では[バックスラッシュエスケープ]が無効になり`\`がそのまま表示されるが、一つだけ例外がある。[表]の見出し及びデータセルの内部ではコードスパン内の`|`に対して[バックスラッシュエスケープ]が必要になる。実例を示す。

```markdown
| 1 | 2 | 3 | 4 | 5 | 6 |
| - | - | - | - | - | - |
| `z = |x| + |y|` | 2 | 3 | 4 | 5 | 6 |
```

> | 1 | 2 | 3 | 4 | 5 | 
> | - | - | - | - | - |
> | `z = |x| + |y|` | 2 | 3 | 4 | 5 | 6 |

このように表の行内では`|`によるセル分割の方がコードスパンより文法的に優先するためセル区切りと判定されてしまう。この場合は次のようにコードスパン内の`|`をバックスラッシュエスケープする(特別ルール)。

```markdown
| 1 | 2 | 3 | 4 | 5 | 6 |
| - | - | - | - | - | - |
| `z = \|x\| + \|y\|` | 2 | 3 | 4 | 5 | 6 |
```

> | 1 | 2 | 3 | 4 | 5 | 6 |
> | - | - | - | - | - | - |
> | `z = \|x\| + \|y\|` | 2 | 3 | 4 | 5 | 6 |

### 文字参照

コードスパン内部では各種書式設定や[文字参照]は使えない(そのまま出力される)。文字参照の代わりに任意のUnicode文字を直接入力すればよい。

```markdown
文字参照は無効 → `cr&egrave;me br&ucirc;l&eacute;e`

直接入力は可 → `crème brûlée`
```

> 文字参照は無効 → `cr&egrave;me br&ucirc;l&eacute;e`
> 
> 直接入力は可 → `crème brûlée`

### コードスパン内の連続スペース

現在のGitHub Markdown環境では([前後のスペース除去](#前後のスペース除去)処理後の)コードスパン内の空白文字はそのまま出力される。特に連続スペースは縮約されず、スペースの数だけ間隔を空けて表示する。

- `` `123456` `` → `123456`
- `` `123 456` `` → `123 456`
- `` `123  456` `` → `123  456`
- `` `123   456` `` → `123   456`
- `` `123    456` `` → `123    456`
- `` `123     456` `` → `123     456`

> 現行のGitHubサイトではコードスパンに対してCSSで`white-space: break-spaces;`が設定されており、上記の通り分かりやすい動作になっている(CSS側で解決)。しかし以前はそうではなかった。
> 
> Markdownを用いたWebサービスの多くはこの設定を行っていない。また以前のGitHubサイト(2022年12月より前)も設定されていなかった。この設定がないとコードスパン内の連続空白は縮約されてスペース1個扱いとして表示され、さらに先頭や末尾の空白が自動除去されるなどの複雑な問題を生じる。
> 
> CSSを設定できない場合に可能な対策は本稿の2022年11月当時の内容に詳しく書いてある(下記リンク)。現行GitHubサイトではもう不要な知識だが、他サイトに文書を移植する場合などに有用な情報なので参考として示しておく。ちなみにコード例の表示結果は当時のCSS設定用のままなので正しくない部分もあることに注意。
> 
> https://github.com/higuma/github-markdown-guide/blob/72c9fe8ef8006b4731f211380616dbf56c0fcaa0/code-spans.md

------------------------------------------------------------------------

[画像](images.md)
← [目次](index.md) →
[HTMLインライン](html-inlines.md)

[インライン]: inlines.md
[表]: tables.md
[文字参照]: characters.md#文字参照

[ノーブレークスペース]: character-references.md#ノーブレークスペース
[バックスラッシュエスケープ]: backslash-escapes.md
