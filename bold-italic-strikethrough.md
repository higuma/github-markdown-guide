# 太字、斜体、打ち消し線

[通常テキスト]
← [目次] →
[リンク]

------------------------------------------------------------------------

Markdown標準の表示効果は[太字]、[斜体]、[打ち消し線]の3種類ある。[太字]はHTML要素の[`<strong>`](https://developer.mozilla.org/ja/docs/Web/HTML/Element/strong)、[斜体]は[`<em>`](https://developer.mozilla.org/ja/docs/Web/HTML/Element/em)、打ち消し線は[`<del>`](https://developer.mozilla.org/ja/docs/Web/HTML/Element/del)にそれぞれ変換される。またこれらを組み合わせて太字斜体、打ち消し線付き太字なども表現できる。

> &#x2714;&#xFE0F; 以降の説明(本章の前半)では対象テキストは境界の外側が行頭・行末または空白文字(スペースなど)で区切られているものとする。区切りなしの場合や境界が[句読文字]の場合はやや複雑なルールがあり、この点に関しては本章の後半「[太字と斜体の文法認識](#太字と斜体の文法認識)」で詳しく解説する。

## 太字

`**テキスト**`または`__テキスト__`のように表示効果を与える対象テキストの前後を`**`または`__`で囲む。これはHTMLの[`<strong>`](https://developer.mozilla.org/ja/docs/Web/HTML/Element/strong)に変換され、ブラウザ上では太字で表示される。

```markdown
**text テキスト**

__text テキスト__
```

> **text テキスト**
> 
> __text テキスト__

境界の内側にスペースを入れてはならない。次は認識しない例。

```markdown
** text テキスト**

__text テキスト __
```

> ** text テキスト**
> 
> __text テキスト __

## 斜体

`*text*`または`_text_`のように表示効果を与える対象テキストの前後を`*`または`_`で囲む。これはHTMLの[`<em>`](https://developer.mozilla.org/ja/docs/Web/HTML/Element/em)に変換され、ブラウザ上では斜体で表示される。

```markdown
*text テキスト*

_text テキスト_
```

> *text テキスト*
> 
> _text テキスト_

やはり境界の内側にスペースを入れてはならない。次は認識しない例(`*`は[順序なしリスト]の行頭マーカーに用いられる文字のため、`* `で始まる行は[リスト]と判定される)。

```markdown
* text テキスト*

_text テキスト _
```

> * text テキスト*
> 
> _text テキスト _

> &#x26A0;&#xFE0F; **Windows環境向け(重要)**: Windowsではブラウザ表示フォントとして[メイリオ]がよく用いられるが、その場合に斜体がラテン文字領域(記号、英数字、ギリシャ文字、キリル文字等)にだけ有効で、その他の文字(日本語のかなや漢字などを含む)には効かないという有名な問題を生じる。
> 
> > <details>
> > <summary>&#x2714;&#xFE0F; <strong>理由</strong></summary>
> > 
> > > <details>
> > > <summary>&#x2714;&#xFE0F; <strong>フォントの基礎知識</strong></summary>
> > > 
> > > この説明にはまずフォントに関する基礎知識を知っておく必要がある。表示に用いるフォントには標準(Regular)、[斜体]\(Italic)、[太字]\(Bold)の文字種があり、これらの集合で一組のフォントとして扱われる。
> > > 
> > > > &#x2714;&#xFE0F; 実際はもっと複雑で、一般に「斜体」と呼ばれる書体には[イタリック体](https://ja.wikipedia.org/wiki/イタリック体)(Italic)と[オブリーク体](https://ja.wikipedia.org/wiki/斜体)(Oblique)の2種類ある。また字の太さ([ウェイト](https://ja.wikipedia.org/wiki/フォント#ウェイト_(太字フォント・細字フォント)))が豊富に用意されているフォントもある。ただしMarkdownではそこまで細かい設定はできない。以下Markdownで設定可能な上記3種類に限定して説明する。
> > > </details>
> > 
> > > <details>
> > > <summary>&#x2714;&#xFE0F; <strong>ブラウザの処理動作</strong></summary>
> > > 
> > > ブラウザなどのHTML表示環境では[斜体]と[太字]に関してだいたい次のように処理している(概要だがこの程度の理解で十分)。[斜体]の場合を示す([太字]も同様)。
> > > 
> > > 1. 表示用フォントが斜体データを持っている場合はそれを使用する(優先)
> > >    1. 斜体データが表示する文字コードに対応していればそれを出力
> > >    2. 表示する文字コードに対して斜体データが未対応の場合に標準フォントで出力(斜体にならない)
> > > 2. 斜体データを持たないフォントはブラウザ側で斜め変形レンダリングして表示
> > > 
> > > ちなみに昔のWindows日本語フォント(MS Pゴシックなど)は斜体データを持たないため、2番目の方法でブラウザが斜め変形処理して表示する。そのため問題は発生しなかった。
> > > </details>
> > 
> > > <details>
> > > <summary>&#x2714;&#xFE0F; <strong>メイリオで生じる問題</strong></summary>
> > > 
> > > 現行Windows用Webブラウザの多くは[メイリオ]を標準の表示フォントに用いている。[メイリオ]は斜体や太字の専用データを持つが、斜体は不完全でラテン文字領域しかデータが作られていない。そのため日本語文字は上記条件1-2「斜体データが適用されるがその文字コードに対して未対応」に該当し、標準で表示する。
> > > 
> > > > <details>
> > > > <summary>&#x2714;&#xFE0F; <strong>メイリオのフォント仕様</strong></summary>
> > > > 
> > > > メイリオがこのような仕様になった経緯に関しては次を参照。
> > > > 
> > > > https://ja.wikipedia.org/wiki/メイリオ#フォントファミリーの仕様
> > > > 
> > > > > ただし理由として書かれている「和文は斜体表記を行う文化的背景がない」はおそらく言い訳で、昔から広告分野などで日本語でも斜体文字は用いられている。実際は工数があまりに膨大になるため対応困難だったというのが本当の理由だろう。
> > > > </details>
> > > 
> > > 
> > > 現行Windows用ブラウザの多くはインストール時にメイリオを標準表示フォントに設定するため、ユーザーがフォント設定を変更しない限り[`<em>`](https://developer.mozilla.org/ja/docs/Web/HTML/Element/em)や[`<i>`](https://developer.mozilla.org/ja/docs/Web/HTML/Element/i)を設定しても斜体にならない問題が発生する。またメイリオ以外でもブラウザに斜体データが不完全なフォントを設定すると同じ問題が発生する。
> > </details>
> 
> > <details>
> > <summary>&#x2714;&#xFE0F; <strong>有効な対策</strong></summary>
> > 
> > Windowsユーザーの多くはブラウザのフォント設定をわざわざ変えたりしないし、そもそもこういう問題があることを知る人は少ない。Windowsは現行メジャー環境の一つであるため、どのWeb環境のユーザーに対しても同等の表示を保証する場合は「日本語に斜体を使わない」という回避策しか有効な方法はない。
> > </details>
> 
> &#x26A0;&#xFE0F; 以下斜体を用いるコード例には常に英数字を入れ、英数字のみまたは日本語文字(かな、漢字等)との併記を用いる(日本語のみの文例を回避)。表示フォントに[メイリオ]を用いるブラウザでは日本語部分だけ斜体にならないので、その場合は英数字部分を見て効果を判断すること。

## 打ち消し線

`~~text~~`のように表示効果を与える対象テキストの前後を`~~`で囲む。これはHTMLの[`<del>`](https://developer.mozilla.org/ja/docs/Web/HTML/Element/del)に変換され、ブラウザ上では横線を重ねた状態で表示される。

```markdown
~~text テキスト~~
```

> ~~text テキスト~~

これも境界の内側にスペースがあると認識しない。

```markdown
~~ text テキスト~~

~~text テキスト ~~
```

> ~~ text テキスト~~
> 
> ~~text テキスト ~~

## 組み合わせ

[斜体]、[太字]、[打ち消し線]の3つをネストして組み合わせて用いることができる。組み合わせ方法は多数あるがみな同様の表示結果になるため、ここではそれぞれ一番覚えやすそうなものを代表として1種類だけ示す。

### 太字+斜体

```markdown
***bold+italic***
```

> ***bold+italic***

> <details>
> <summary>&#x2714;&#xFE0F; 全ての書き方(全6通り)</summary>
> 
> - `***bold+italic***` → ***bold+italic***
> - `___bold+italic___` → ___bold+italic___
> - `**_bold+italic_**` → **_bold+italic_**
> - `__*bold+italic*__` → __*bold+italic*__
> - `*__bold+italic__*` → *__bold+italic__*
> - `_**bold+italic**_` → _**bold+italic**_

</details>

### 太字+打ち消し線

```markdown
~~**bold+strikeout**~~
```

> ~~**bold+strikeout**~~

> <details>
> <summary>&#x2714;&#xFE0F; 全ての書き方(全4通り)</summary>
> 
> - `**~~bold+strikeout~~**` → **~~bold+strikeout~~**
> - `__~~bold+strikeout~~__` → __~~bold+strikeout~~__
> - `~~**bold+strikeout**~~` → ~~**bold+strikeout**~~
> - `~~__bold+strikeout__~~` → ~~__bold+strikeout__~~
> </details>

### 斜体+打ち消し線

```markdown
~~*italic+strikeout*~~
```

> ~~*italic+strikeout*~~

> <details>
> <summary>&#x2714;&#xFE0F; 全ての書き方(全4通り)</summary>
> 
> - `*~~italic+strikeout~~*` → *~~italic+strikeout~~*
> - `_~~italic+strikeout~~_` → _~~italic+strikeout~~_
> - `~~*italic+strikeout*~~` → ~~*italic+strikeout*~~
> - `~~_italic+strikeout_~~` → ~~_italic+strikeout_~~
> </details>

### 太字+斜体+打ち消し線

```markdown
~~***bold+italic+strikeout***~~
```

> ~~***bold+italic+strikeout***~~

> <details>
> <summary>&#x2714;&#xFE0F; 全ての書き方(全20通り)</summary>
> 
> - `***~~bold+italic+strikeout~~***` → ***~~bold+italic+strikeout~~***
> - `**_~~bold+italic+strikeout~~_**` → **_~~bold+italic+strikeout~~_**
> - `__*~~bold+italic+strikeout~~*__` → __*~~bold+italic+strikeout~~*__
> - `___~~bold+italic+strikeout~~___` → ___~~bold+italic+strikeout~~___
> - `**~~*bold+italic+strikeout*~~**` → **~~*bold+italic+strikeout*~~**
> - `**~~_bold+italic+strikeout_~~**` → **~~_bold+italic+strikeout_~~**
> - `__~~*bold+italic+strikeout*~~__` → __~~*bold+italic+strikeout*~~__
> - `__~~_bold+italic+strikeout_~~__` → __~~_bold+italic+strikeout_~~__
> - `*__~~bold+italic+strikeout~~__*` → *__~~bold+italic+strikeout~~__*
> - `_**~~bold+italic+strikeout~~**_` → _**~~bold+italic+strikeout~~**_
> - `*~~**bold+italic+strikeout**~~*` → *~~**bold+italic+strikeout**~~*
> - `*~~__bold+italic+strikeout__~~*` → *~~__bold+italic+strikeout__~~*
> - `_~~**bold+italic+strikeout**~~_` → _~~**bold+italic+strikeout**~~_
> - `_~~__bold+italic+strikeout__~~_` → _~~__bold+italic+strikeout__~~_
> - `~~***bold+italic+strikeout***~~` → ~~***bold+italic+strikeout***~~
> - `~~**_bold+italic+strikeout_**~~` → ~~**_bold+italic+strikeout_**~~
> - `~~__*bold+italic+strikeout*__~~` → ~~__*bold+italic+strikeout*__~~
> - `~~___bold+italic+strikeout___~~` → ~~___bold+italic+strikeout___~~
> - `~~*__bold+italic+strikeout__*~~` → ~~**_bold+italic+strikeout_**~~
> - `~~_**bold+italic+strikeout**_~~` → ~~_**bold+italic+strikeout**_~~
> </details>

## ネスト

これら3種類の書式は互いに部分的にネストすることも可能で、例えば全体が太字でその中の一部が太字+斜体の場合は次のように書いてよい。

```markdown
**Bold _and italic_**
```

> **Bold _and italic_**

> &#x2714;&#xFE0F; `**Bold *and italic***`等でもよい(組み合わせは4通り)。ただし同じ記号を使うと認識しないMarkdown実装がある(→ [Babelmark](https://babelmark.github.io/?text=**Bold+*and+italic***))。またそれぞれのネスト範囲を明示する意味で記号を分けた方が意味が分かりやすい。

ネスト(入れ子)構造に従っていればどのような組み合わせも可能。

```markdown
**太字で~~さらに取り消し線~~の後で太字に戻る**

_Italic **and bold ~~and strikeout~~** → back to italic_
```

> **太字で~~さらに取り消し線~~の後で太字に戻る**
> 
> _Italic **and bold ~~and strikeout~~** → back to italic_

ただしネストはできてもオーバーラップはできない。次は意図的に作った失敗例で、`**...**`の範囲を太字、`_..._`の範囲を斜体、そして両者の共通部分は斜体+太字に設定しようとしたもの。しかしネスト構造の条件を満たしていないため意図した通りに文法認識してもらえない。

```markdown
**Bold _bold+italic** italic_
```

> **Bold _bold+italic** italic_

正しくは次の通り。ネスト構造に従って記述する必要があるため`bold+italic`の後でいったん書式設定を終了し、その後で`italic`を単独の斜体に設定する。

```markdown
**Bold _bold+italic_** _italic_
```

> **Bold _bold+italic_** _italic_

> <details>
> <summary>&#x2714;&#xFE0F; <strong>全ての書き方(全8通り)</strong></summary>
> 
> - `**Bold *bold+italic*** *italic*` → **Bold *bold+italic*** *italic*
> - `**Bold *bold+italic*** _italic_` → **Bold *bold+italic*** _italic_
> - `**Bold _bold+italic_** *italic*` → **Bold _bold+italic_** *italic*
> - `**Bold _bold+italic_** _italic_` → **Bold _bold+italic_** _italic_
> - `__Bold *bold+italic*__ *italic*` → __Bold *bold+italic*__ *italic*
> - `__Bold *bold+italic*__ _italic_` → __Bold *bold+italic*__ _italic_
> - `__Bold _bold+italic___ *italic*` → __Bold _bold+italic___ *italic*
> - `__Bold _bold+italic___ _italic_` → __Bold _bold+italic___ _italic_
> </details>

## エスケープ

通常テキストの中に`*`,`_`,`~~`が含まれており、表示効果の書式と一致する場合は適宜[バックスラッシュエスケープ]を用いて表示効果ではないことを認識させる。全てをエスケープする必要はなく、文法認識の起点となる[ASCII句読文字]の部分をエスケープすればよい。

```markdown
\*not italic*

\_not italic_

\~~取り消し線ではない~~
```

> \*not italic*
> 
> \_not italic_
> 
> \~~取り消し線ではない~~

> &#x2714;&#xFE0F; **参考**: 代わりに[文字参照]を用いてもよい。ただし[バックスラッシュエスケープ]の方が楽に書ける。
> 
> ```markdown
> &ast;not italic*
> ```
> 
> > &ast;not italic*

ただし太字の場合に注意。エスケープ1つだけでは足りず、残りの部分が斜体と認識される。先頭の2つを両方エスケープしてやっと通常文字と認識される。

```markdown
\**italic surrounded by asterisks**

\__italic surrounded by underscores__

\*\*normal text**

\_\_normal text__
```

> \**italic surrounded by asterisks**
> 
> \__italic surrounded by underscores__
> 
> \*\*normal text**
> 
> \_\_normal text__

太字斜体も同様で、先頭の3つ全てエスケープする必要がある。`*`の場合のみ示す(`_`も同様)。

```markdown
***bold and italic***

\***bold surrounded by asteriks***

\*\**italic surrounded by double-asteriks***

\*\*\*normal text***
```

> ***bold and italic***
> 
> \***bold surrounded by asteriks***
> 
> \*\**italic surrounded by double-asteriks***
> 
> \*\*\*normal text***

> &#x2757;&#xFE0F; **注意**: 以上はGitHub Markdownの動作だが、別のMarkdown実装では詳細動作が異なる場合もある(Babelmarkで確認すると実際にある)。他のMarkdown環境上でも使う可能性がある文章の場合は想定し得る箇所全てをエスケープするとよい(推奨)。

## 適用箇所

[インライン]アイテムを挿入可能な場所であればどこにでも記述できる。

```markdown
> _ブロック引用の中: Inside of a block quote_

- **リストの中**

### ***見出しの中: Inside of a heading***

| *表の中* |
| -------- |
| ~~セル~~ |
```

> > _ブロック引用の中: Inside of a block quote_
> 
> - **リストの中**
> 
> ### ***見出しの中: Inside of a heading***
> 
> | *表の中* |
> | -------- |
> | ~~セル~~ |

## インラインの内部挿入

太字・斜体・打ち消し線の認識は他の[インライン]アイテムより低く設定されているため、内部に各種[インライン]アイテムを挿入できる。次のように文字出力を伴う[インライン]アイテムの多くに効果がある。

- [リンク]
  - 通常リンク: `_[PAGE TOP](#)_` → _[PAGE TOP](#)_
  - 自動リンク: `**Send to <nobody@example.com>.**` → **Send to <nobody@example.com>.**
  - 拡張自動リンク: `***Visit http:://github.com/ later.***` → ***Visit https://github.com/ later.***
- [HTMLインライン]\(GitHub環境で有効なもの)
  - 上付き文字: `_N<sup>2</sup>_` → _N<sup>2</sup>_
  - 下付き文字: `**NH<sub>3</sub>**` → **NH<sub>3</sub>**
  - 変数: `**<var>y</var> = 2<var>x</var>**` → **<var>y</var> = 2<var>x</var>**
  - ルビ: `___<ruby>海月<rt>くらげ</rt></ruby>___` → ___<ruby>海月<rt>くらげ</rt></ruby>___
  - サンプル出力: `**<samp>logout</samp>**` → **<samp>logout</samp>**
  - 行内引用: `~~<q>引用取り消し</q>~~` → ~~<q>引用取り消し</q>~~

テキストを文字通り出力する目的のアイテムや、テキストではないアイテムも挿入可能だが効果はない。

- [コードスパン]: ``**ここは太字、`効果なし`**`` → **ここは太字、`効果なし`**
- [画像]: `_Italic here, ![](img/arrow-right-circle.svg)_` → _Italic here, ![](img/arrow-right-circle.svg)_

## 太字と斜体の文法認識

最後に太字と斜体の詳しい文法認識ルールについて解説する。なおGithHub Flavored Markdown (以下「[GFM]」)仕様書の記述は実装者用で難解な表現を用いているため、ここでは(多少の厳密さを犠牲にして)文書作成者用の実用的な表現に書き換えて説明する。

> &#x2757;&#xFE0F; **注意** 以下の内容はGitHubの実環境で確認済みだが、GitHub (CommonMarkベース)以外のMarkdown実装/環境では動作が異なる可能性がある。他環境への対応まで考慮した対処方法は本節最後の[実用的なまとめ](#実用的なまとめ)を参照(特にバックスラッシュエスケープに関する記述)。

### 空白と句読文字

まず太字や斜体の強調対象テキストの先頭や末尾は空白であってはならない。次のように間に空白があると認識しない。

- `*a* _a_` → *a* _a_ (斜体と認識)
- `* a* _ a_` → * a* _ a_ (認識しない)
- `**a** __a__` → **a** __a__ (太字と認識)
- `**a ** __ a__` → **a ** __ a__ (認識しない)

> &#x2714;&#xFE0F; [GFM]仕様書の定義に従えば強調書式の認識処理における「空白」は「1個以上の[Unicode空白文字]」を意味する(一覧は [付録 - Unicode空白文字一覧](unicode-whitespace-characters.md) を参照)。ただし単純にスペースと同義と考えても実用上差し支えない(実際にスペースはこの中に含まれている)。

また強調文字の境界が`"`や`{`,`}`のような文字の場合に判定条件が変化する。これらの文字は[GFM]仕様書の用語で**句読文字**(punctuation characters)と呼ばれる。定義は [文字と行 - 句読文字](characters.md#句読文字) を参照。一覧は [付録 - 句読文字一覧](punctuation-characters.md) を参照。

文法認識は強調記述文字が`*`の場合と`_`の場合で動作が異なる。はじめに`*`の場合を示し、その後で`_`の場合を説明する。

> &#x2714;&#xFE0F; この仕様の非対称性は初期のMarkdownから存在し、特に[スネークケース]の扱いを意識している。例えば`NUMBER_OF_PRIMES`のような場合に中間の`_OF_`を斜体と認識させないように仕様が作られている。

### `*`の場合

`*`の場合は基本的に`*...*`の外部に空白がなくても認識する。ただし`*"foo"*`のように強調対象の先頭や末尾が[句読文字]の場合は境界として空白または[句読文字]が必要。まず斜体の場合を例文で示す。

1. `a *b* c` → a *b* c (`*b*`を斜体と認識)
2. `a*b*c` → a*b*c (`*`は密着していても認識する)
3. `a*"b"*c` → a*"b"*c (強調対象の先頭や末尾が[句読文字]の場合は密着すると認識しない)
4. `a *"b"* c` → a *"b"* c (境界を空白で区切れば認識する)
5. `a&shy;*"b"*&shy;c` → a&shy;*"b"*&shy;c ([ソフトハイフン]を用いて認識)

例5の`&shy;`(U+00AD)は[ソフトハイフン]で、[非表示区切り]としての機能を持ち、斜体認識時は[句読文字]として扱われる。これを用いて間を空けずに任意の区間に対して斜体設定を行うことができる。

太字の場合は上記の`*`を`**`に置き換えればよい。

1. `a **b** c` → a **b** c (`**b**`を太字と認識)
2. `a**b**c` → a**b**c (`**`は密着していても認識する)
3. `a**"b"**c` → a**"b"**c (強調対象の先頭や末尾が[句読文字]の場合は密着すると認識しない)
4. `a **"b"** c` → a **"b"** c (境界を空白で区切れば認識する)
5. `a&shy;**"b"**&shy;c` → a&shy;**"b"**&shy;c ([ソフトハイフン]を用いて認識)

### `_`の場合

`_`の場合は密着した場合のルールが異なる。まず斜体の場合。

1. `a _b_ c` → a _b_ c (`_b_`を斜体と認識)
2. `a_b_c` → a_b_c (`_`は密着していると認識しない)
3. `a&shy;_b_&shy;c` → a&shy;_b_&shy;c (密着して認識させるには[ソフトハイフン]を用いる)
4. `a_"b"_c` → a_"b"_c (強調対象の先頭や末尾が[句読文字]の場合: まず認識しない例)
5. `a _"b"_ c` → a _"b"_ c (境界を空白で区切って認識)
6. `a&shy;_"b"_&shy;c` → a&shy;_"b"_&shy;c ([ソフトハイフン]を用いて認識)

太字の場合。

1. `a __b__ c` → a __b__ c (`__b__`を太字と認識)
2. `a__b__c` → a__b__c (`__`は密着していると認識しない)
3. `a&shy;__b__&shy;c` → a&shy;__b__&shy;c (密着して認識させるには[ソフトハイフン]を用いる)
4. `a__"b"__c` → a__"b"__c (強調対象の先頭や末尾が[句読文字]の場合: まず認識しない例)
5. `a __"b"__ c` → a __"b"__ c (境界を空白で区切って認識)
6. `a&shy;__"b"__&shy;c` → a&shy;__"b"__&shy;c ([ソフトハイフン]を用いて認識)

### 内部に`*`や`_`を含む場合

強調テキストが`*`や`_`を含む場合は、上記ルールに該当して強調書式と認識されないように[バックスラッシュエスケープ]または[文字参照]を用いた対策が必要になる場合がある。

```markdown
- 失敗例 → **この文章は内部に**を含む**
- 対策 → **この文章は内部に\*\*を含む**
```

> - 失敗例 → **この文章は内部に**を含む**
> - 対策 → **この文章は内部に\*\*を含む**

ただし[スネークケース]の場合は必要ない。

```markdown
__この文章の内部の__はエスケープ不要__
```

> __この文章の内部の__はエスケープ不要__

しかし前後に[句読文字]がある場合はエスケープが必要。

```markdown
- 失敗例 → __この文章の内部の{__}にはエスケープが必要__
- 対策 → __この文章の内部の{\_\_}にはエスケープが必要__
```

- 失敗例 → __この文章の内部の{__}にはエスケープが必要__
- 対策 → __この文章の内部の{\_\_}にはエスケープが必要__

ただし個別ケースをいちいち覚えるのが面倒であれば、何も考えず常にエスケープしておく方が間違いない。また強調認識はMarkdown実装により細かい動作に違いがあり、特定のケースでエスケープが必要な実装とそうでない実装の両方が存在することが多い。エスケープしておけばどの実装でも同じ動作を保証できる。

### 実用的なまとめ

実用的知識として次を覚えておけばよい。

- 強調対象文字の先頭と末尾は必ず印字文字(空白を入れてはならない)
- 強調区間(`*...*`,`**...**`,`_..._`,`__...__`)の外側境界に空白または[句読文字]が必要な場合がある
  - スペースを入れてよい場合はそれで認識させる
  - 密着する場合は[非表示区切り]\([ソフトハイフン]`&shy;`など)を用いると解決できる
- 強調テキスト内に`*`や`_`が含まれる場合は適宜[バックスラッシュエスケープ]を用いる
  - `*`に関しては常にエスケープすべき
  - [スネークケース]の場合は不要(`abc_def_ghi`)だが、エスケープした方が丁寧

------------------------------------------------------------------------

> &#x26A0;&#xFE0F; **注意**: 実用的な内容はここまで。以下最後まで実装者または詳細仕様に特別な興味がある読者向け。文書作成技術の習得にはまず役に立たない内容なので決してお勧めしない。

## GFMの詳細仕様

GFM仕様書の強調(太字と斜体)に関する仕様記述は非常に長大かつ難解で、解読はかなり難しい。また理解が進んでくると、今度は仕様書自体に不完全な点が多いことも分かってくる。

> これは数学の証明ではなく、文書作成用フォーマットの仕様説明が目的なので不完全な部分はある程度許容して考えるべき。仕様を示す側から考えると全て説明し尽くすのは困難で、細かい部分はどうしても実装者に委ねられる部分が実際にある。

以下は基本的にはGFM仕様書の記述に従った上で、できる限りより分かりやすい表現に置き換えながら説明していく。また仕様書の全てを説明し尽くすのはあきらめ(これをやろうとするとあまりに困難だし、そもそも仕様書自体が不完全)、その代わり核心部分を確実に理解できるような解説を心がける。

### 評価の優先順位

まずはじめにMarkdownが行う文法解析手順を手短に説明する。Markdownの文法認識はソーステキスト入力を先頭から末尾まで順番に解析して行う。まず[ブロック]アイテムの認識を行い、各々の[ブロック]は[改行]により切り分けられる。また[ソフト改行]などにより行の連結が発生するケースはあらかじめ処理して連結される。

次に各ブロック内部の[インライン]アイテムを解析する。切り分けられた部分テキストの先頭から末尾まで順番に解析し、Markdownの文法書式を検出するとそれを[インライン]アイテムと認識する。ただし各アイテムには認識(評価)の優先順位があり、高いものほど優先して先に処理される。

太字と斜体の認識優先順位は[リンク]、[画像]、[コードスパン]、[HTMLインライン]など他の[インライン]アイテムより低く設定されており、これにより内部に他のインラインアイテムを取り込むことができる。この点に関してはすでに説明しており、詳しくは[インラインの内部挿入](#インラインの内部挿入)を参照。

> &#x2714;&#xFE0F; GFM仕様書ではRule 17が該当部。

以下の解説では優先順位の高いアイテムの認識が先に終了しているものとし、その内部のテキストコンテントに対しする太字と斜体の認識規則の適用方法を説明する。

> &#x2714;&#xFE0F; ここから先はGFM仕様書の用語表現に従って解説する。ただしGFM(より正確にはその引用元のCommonMark)仕様書は全て英文のみで表現する記法を用いている(英語を熟知した人でないと解読困難)。そこで特定言語に依存しない簡潔な表現として適宜数学記号を用いた記法で説明する。

### 連続区切り

エスケープされていない`*`または`_`の同種1文字以上の最大連続部分文字列を**連続区切り**(delimiter run)といい、太字と斜体の認識マーカーとして用いる。

> "delimiter run"は日本語にすると「区切りの連なり」程度の意味。ここでは「連続区切り」とした。

これらを太字や強調の開始・終了とするかどうかはその前後の文字種パターンにより判定を行う。強調の開始となり得る連続区切りを**左側面連続区切り**(left-flanking delimiter run)、強調の終了となり得る連続区切りを**右側面連続区切り**(right-flanking delimiter run)と呼ぶ。

> <details>
> <summary>&#x2714;&#xFE0F; <strong>GFM仕様書の記述</strong></summary>
> 
> 左側面連続区切りはGFM仕様書では次のように定義されている(忠実な和訳)。
> 
> 1. その次はUnicode空白(または行末)ではなく(not followed by Unicode whitespace)
> 2. さらに次のどちらかの条件を満たす
>    - (2a) その次は句読文字でもない(not followed by a punctuation character)
>    - (2b) その次は句読文字(followed by a punctuation character)で、さらに次のどちらかを満たす
>      - その前はUnicode空白(または行頭) (preceded by Unicode whitespace)
>      - その前は句読文字 (preceded by a punctuation character)
> 3. 以上の定義で行頭・行末はUnicode空白扱いとする(the beginning and ... as Unicode whitespace)
> 
> > 3の「行頭・行末」(the beginning and the end of the line)という表現は厳密には不正確で、連続区切りの認識は行単位ではなく[ブロック]分割終了後の内の[インライン]ソーステキスト(部分文字列)に対して行う。そのため本解説では「文頭・文末」という表現に修正している。
> 
> 上記表現は理解の補助として階層リストを用いたが、実際の仕様書は全て冗長な英文による表現で記述されており、解読が非常に難しい。そこで以下では冗長性を排除した上で厳密な記述を行うために数学記号を導入して表現した(意味は同じ)。
> </details>

以下の定義では次の記号を用いる。

- $\varnothing$ : 文字なし(文頭または文末を表す)
- $s$ : [Unicode空白文字]
- $p$ : [句読文字]
- $P$ : 非句読印字文字 - 句読文字を除く全ての印字文字(Unicode空白文字は定義により除外)
- $d^N$ : 連続区切り - エスケープされていない`*`または`_`の同種1個以上最長連続
  - 連続数を $N$ とする
  - e.g. `**`, `___`
- $d_L^N$ : 左側面連続区切り - 強調書式の始端条件を満たす $d^N$
- $d_R^N$ : 右側面連続区切り - 強調書式の終端条件を満たす $d^N$

> &#x2714;&#xFE0F; 連続区切りが「エスケープされていない最長連続」という点はGFM仕様書のRules 11,12に書かれているが、その英文表現は冗長かつ難解で読み解きにくい。実は難しいことではないのでここでは平易な表現に改めた。

これらを用いると左右の側面連続区切りは次のパターンで表現できる。

- $d_L^N$ : 次のいずれかのパターンに一致する $d^N$
  - $d^N$ $P$ (e.g. `...**abc...`, `..._あいう...`)
  - $\varnothing$ $d^N$ $p$ (e.g. `*"abc...`, `__!あいう...`)
  - $s$ $d^N$ $p$ (e.g. `... *"abc...`, `...&nbsp;__!あいう...`)
  - $p$ $d^N$ $p$ (e.g. `..."*$abc...`, `...!__"あいう...`)
- $d_R^N$ : 次のいずれかのパターンに一致する $d$ ($d_L$ のちょうど逆)
  - $P$ $d^N$ (e.g. `...xyz**...`, `...わをん_...`)
  - $p$ $d^N$ $\varnothing$ (e.g. `...xyz"*`, `...わをん!__`)
  - $p$ $d^N$ $s$ (e.g. `...xyz"* ...`, `...わをん!&nbsp;...`)
  - $p$ $d^N$ $p$ (e.g. `...xyz$*"...`, `...わをん"__!...`)

また左右両方に対して側面連続区切り条件が成立する場合を**両側面連続区切り**と呼び $d_{LR}^N$ で表す。該当するパターンは次の2通りある。

- $d_{LR}^N$ : 次のいずれかのパターンに一致する $d^N$
  - $P$ $d^N$ $P$ (e.g. `...xyz**abc...`)
  - $p$ $d^N$ $p$ (e.g. `...xyz!_!abc...`)

### 強調範囲の検出

文法解析は文書の文字列ストリーム順に行い、左右の側面連続区切りの組を検出すると次にそれが強調書式の条件を満たすかどうかの判定を行う。この際に連続区切りとして`*`を用いる場合と`_`を用いる場合で判定条件が異なる。そこで以降は記号を次のように区別して表現する。

- $a^N$ : 連続アスタリスク - エスケープされていない`*`の1個以上最大連続(連続数を $N$ とする)
- $a_L^N$ : 左側面連続アスタリスク - 左側面連続区切りの条件を満たす $a^N$
- $a_R^N$ : 右側面連続アスタリスク - 右側面連続区切りの条件を満たす $a^N$
- $a_{LR}^N$ : 両側面連続アスタリスク - $a_L^N$, $a_R^N$ 両方の条件を満たす $a^N$
- $u^N$ : 連続アンダースコア - エスケープされていない`_`の1個以上最大連続(連続数を $N$ とする)
- $u_L^N$ : 左側面連続アンダースコア - 左側面連続区切りの条件を満たす $u^N$
- $u_R^N$ : 右側面連続アンダースコア - 右側面連続区切りの条件を満たす $u^N$
- $u_{LR}^N$ : 両側面連続アスタリスク - $u_L^N$, $u_R^N$ 両方の条件を満たす $u^N$

#### `*`の場合

`*`の場合は単純に $a_L^N$ を強調書式の始端候補、 $a_R^N$ を強調書式の終端候補と認識する。

- $a_L^N$ は強調書式の始端候補
- $a_R^N$ は強調書式の終端候補

> &#x2714;&#xFE0F; GFM仕様書ではRules 1,3,5,7が該当部。

#### `_`の場合

`_`の場合は次の追加条件が付く。 $u_L^N$が強調書式始端候補となる場合を $u_{L*}^N$、また $u_R^N$ が強調書式終端候補となる場合を $u_{R*}^N$ とする。

- $u_L^N$ が次のどちらかの条件を満たす場合に強調書式の始端候補(これを $u_{L*}^N$ とする)
  - $u_{LR}^N$ の条件を満たさない
  - $p$ $u_{LR}^N$ $p$ のパターンにマッチ
- $u_R^N$ が次のどちらかの条件を満たす場合に強調書式の終端候補(これを $u_{R*}^N$ とする)
  - $u_{LR}^N$ の条件を満たさない
  - $p$ $u_{LR}^N$ $p$ のパターンにマッチ

> &#x2714;&#xFE0F; GFM仕様書ではRules 2,4,6,8が該当部。この条件により[スネークケース]\(e.g. `abc_def_ghi`)の中間にある`_`は強調とは認識されない。

### 強調の適用

以上の解析手順により強調書式の始端・終端候補を検出すると、次にそれらが実際に左右マッチするかどうかを順番に判定してマッチが成立した箇所に太字・斜体を適用する。

#### 基本ルール

基本ルールをまとめると次の通り。なお **テキスト** の部分は空であってはならず、必ず何らかの印字文字を含む必要がある。太字と斜体の両方が適用可能な場合は常に太字を適用する(優先度が高い)。

1. $a_L^{N \ge 2}$ **テキスト** $a_R^{N \ge 2}$ のパターンを検出すると太字を適用(優先)
2. $u_{L*}^{N \ge 2}$ **テキスト** $u_{R*}^{N \ge 2}$ のパターンを検出すると太字を適用(優先)
3. $a_L^{N \ge 1}$ **テキスト** $a_R^{N \ge 1}$ のパターンを検出すると斜体を適用(太字より低い)
4. $u_{L*}^{N \ge 1}$ **テキスト** $a_{R*}^{N \ge 1}$ のパターンを検出すると斜体を適用(太字より低い)
5. 上記1,3にマッチした始端または終端が $a_{LR}^N$ の条件を満たす場合はさらに次を判定
   - 始端の $N$ と 終端の $N$ の和が3の倍数でない場合は適用
   - 始端の $N$ が3の倍数で、終端の $N$ も3の倍数の場合は適用
   - それ以外は不適用
6. 上記2,4にマッチした始端または終端が $u_{LR*}^N$ の条件を満たす場合はさらに次を判定
   - 始端の $N$ と 終端の $N$ の和が3の倍数でない場合は適用
   - 始端の $N$ が3の倍数で、終端の $N$ も3の倍数の場合は適用
   - それ以外は不適用
7. 複数のパターンがオーバーラップしている場合は先着優先
8. 複数パターンがネストしている場合は内側から解決(内側優先)
9. 1,2のルールにより太字を適用すると各々の始端・終端の $N$ を2減らし、0になった場合は完了(マーカー削除)、1以上であればマーカーを残して最初に戻り他の強調を再評価
10. 3,4のルールにより斜体を適用すると各々の始端・終端の $N$ を1減らし、0になった場合は完了(マーカー削除)、1以上であればマーカーを残して最初に戻り他の強調を再評価

> &#x2714;&#xFE0F; ルール1,2,3,4,5,6はGFM仕様書のRules 9,10に対応する。

#### 太字優先

まず「太字は斜体より優先度が高い」の意味から説明する。実はCommonMark仕様では同じ強調の多重掛けが認められており、例えば`****Nested bold****`は`<strong><strong>Nested bold</strong></strong>`に変換される。

> &#x2714;&#xFE0F; 英文ではよく引用文を斜体で表現するが、その文章をさらに別の文章で引用すると「引用を含む引用」という構造になる。そのさらに引用というケースも考えられるため、CommonMarkは再帰的な構文を認識できる仕様を採用し、GFMはそれをそのまま継承している。
> 
> > ただし通常の環境では太字や斜体を多重掛けしても視覚効果は同じで、外見からは認識できない。CSSで特殊な設定をすれば話は別だが、GitHubではMarkdownからはCSS設定は行えないように保安上の対策が施されている(できない)。

この多重掛けを許容すると、今度は`**abc**`に対して`<strong>abc</strong>`と`<em><em>abc</em></em>`の両方を適用可能ということになる。そこでこのような場合に「太字優先」というルールを適用し、両方が可能な場合は常に太字から適用することにより一意的解釈を得ることができる。

> &#x2714;&#xFE0F; GFM仕様書ではRules 13,14が該当部。

#### 先着優先

次は「先着優先」の例。マッチするペアがオーバーラップしている場合に適用する。

```markdown
*abc _def* ghi_
```

> *abc _def* ghi_

構造は $a_L^1$ `abc ` $u_L^1$ `def` $a_R^1$ ` ghi` $u_R^1$ となり、 $a_L^1$ **...** $a_R^1$ による斜体と $u_L^1$ **...** $u_R^1$ による斜体がオーバーラップした状態になっている。この場合に先着優先を適用して先に検出した方のみ適用し、他方は適用せずそのままテキスト出力する。

> &#x2714;&#xFE0F; GFM仕様書ではRules 15,16が該当部。

#### 内側優先

次は「内側優先」の文例。

```markdown
**abc **def ghi**
```

> **abc **def ghi**

構造は $a_L^2$ `abc ` $a_L^2$ `def ghi` $a_R^2$ となり、 $a_L^2$ が二重なのに対して $a_R^2$ は一つしかない。この場合に「内側優先」が適用され、内側の`**def ghi**`の部分だけ太字を適用し、手前の`**abc `はそのままテキスト出力する。

#### マッチの再帰的な適用

マッチが成立すると対応する始端・終端の $N$ を太字の場合は2、斜体の場合は1減らし、0になったらその末端は消去する。まだ始端と終端が両方残っている場合は再度マッチを適用して以下再帰的に処理を行い、左右でマッチ成立するペアがなくなったら処理を終了する。次の例文で説明する。

```markdown
**abc *def***
```

> **abc *def***

1. 構造は $a_L^2$ `abc ` $a_L^1$ `def` $a_R^3$
2. 「内側優先」を適用して内側の $a_L^1$ `def` $a_R^3$ を斜体と認識 → `<em>def</em>`
3. マッチした $a_L$ , $a_R$ の $N$ を1減らし、0になったら消去(左側は完了、右側だけ残る)
   - → $a_L^2$ `abc <em>def</em>` $a_R^2$
4. 再び文法解析: 全体の $a_L^2$ **...** $a_R^2$ に「太字優先」を適用して太字と認識
   - → $a_L^2$ `abc <em>def</em>` $a_R^2$
5. マッチした $a_L$ , $a_R$ の $N$ を2減らす → 両方0となり消去して完了
   - → `<strong>abc <em>def</em></strong>`

#### 3の倍数ルール

マッチした始端と終端のどちらかが両側面連続区切りの条件を満たす場合は、追加条件として3の倍数に関するルールを適用する。例として次を考える。

```markdown
*abc**def*
```

> *abc**def*

構造は $a_L^1$ `abc` $a_{LR}^2$ `def` $a_R^1$ となり、中間が左右どちらにもマッチ可能な状態になっている。この場合に「3の倍数ルール」を用いて判定を行い、次の2つが不適用となる。

* 左側候補: $a_L^1$ `abc` $a_{LR}^2$ → 両側の $N$ の和は $1+2=3$ のため3の倍数となり不適用
* 右側候補: $a_{LR}^2$ `def` $a_R^1$ → 両側の $N$ の和は $2+1=3$ のため3の倍数となり不適用

これにより両端の $a_L^1$ ... $a_R^1$ だけが適用可能な候補となり、中間の`**`はそのままテキスト出力して全体に斜体を適用する。

> &#x26A0;&#xFE0F; **注意**: この3の倍数に関するルールはCommonMark系特有のものであり、他のMarkdown実装は動作が異なる(→ [BabelMark](https://babelmark.github.io/?text=*abc**def*))。

もうひとつの「3の倍数ルール」として、両端とも両側面連続区切りであり、かつ双方の $N$ がどちらも3の倍数である場合は適用される。

```markdown
abc***def***ghi
```

> abc***def***ghi

構造は `abc` $a_{LR}^3$ `def` $a_{LR}^3$ `ghi` となり、左右両方とも両側面連続区切りで、さらに $N$ が3の倍数のため`def`に太字斜体を適用する。

### 現実的な対処方法

以上CommonMark/GFM仕様に基づいた強調の認識方法に関して詳細に説明した。ただしこのような知識は仕様を作る際やその実装を行う際には必要だが、文書作成にはあまり役に立つことはないということを強調しておく。

> <details>
> <summary>&#x2714;&#xFE0F; <strong>問題を生じやすい文例</strong></summary>
> 
> そもそもCommonMark仕様が既存仕様のなかで最良かというと必ずしもそうとは言えない部分もある。例えば次の例はいかにもオーバーラップによる先着優先が適用されそうだが、実はCommonMark仕様では斜体の3重ネストにより解決可能で`*abc _*def* ghi_*`のように認識される。
> 
> ```markdown
> *abc **def* ghi**
> ```
> 
> > *abc **def* ghi**
> 
> > これを解決する手順はGFM仕様書のAppendix: [An algorithm for parsing nested emphasis and links](https://github.github.com/gfm/#an-algorithm-for-parsing-nested-emphasis-and-links)に書かれている。ただし知っていても全く実用性はない知識なので本解説では省略した。
> 
> しかし[BabelMark](https://babelmark.github.io/?text=*abc+**def*+ghi**)で確認するとやはり出力は様々で、特に(太字優先を適用して)`**`を太字と認識するものが多数ある。この`*abc **def* ghi**`のケースは確かに斜体の3重掛けで解決可能だが、人間が自然と感じる解釈はむしろ斜体と太字がオーバーラップした状態という意見も多いだろう。
> </details>

このような詳細仕様に依存した記述はCommonMark系以外のMarkdown実装への応用が効かない。そうではなく、逆にどのようなMarkdown実装でも同じように文法認識されるような記述方法を考えた方が遥かに実用的であり、得るものも大きい。

------------------------------------------------------------------------

[通常テキスト]
← [目次] →
[リンク]

[ASCII句読文字]: characters.md#ascii句読文字
[GFM]: github-flavored-markdown.md
[HTMLインライン]: html-inlines.md
[Unicode空白文字]: characters.md#unicode空白文字
[インライン]: inlines.md
[コードスパン]: code-spans.md
[スネークケース]: https://ja.wikipedia.org/wiki/キャメルケース#その他の綴り方
[ソフトハイフン]: https://ja.wikipedia.org/wiki/ソフトハイフン
[ソフト改行]: paragraphs.md#ソフト改行
[バックスラッシュエスケープ]: characters.md#バックスラッシュエスケープ
[ブロック]: blocks.md
[メイリオ]: https://ja.wikipedia.org/wiki/メイリオ
[リスト]: lists.md
[リンク]: links.md
[打ち消し線]: #打ち消し線
[改行]: characters.md#改行
[画像]: images.md
[句読文字]: characters.md#句読文字
[斜体]: #斜体
[順序なしリスト]: lists.md#順序なしリスト
[通常テキスト]: texts.md
[非表示区切り]: texts.md#非表示区切り
[太字]: #太字
[目次]: index.md#bold-italic-strikethrough
[文字参照]: characters.md#文字参照
